отчет по лабораторной работе №7

1) исходный код параметризуемого декоратора logger


def logger(func=None, *, handle=sys.stdout):
    """
    простой декоратор-логгер, handle может быть stdout, файлом или logging.Logger
    """

    # если декоратор вызвали как логгер
    if func is None:
        def deco(f):
            return logger(f, handle=handle)
        return deco

    @wraps(func)
    def wrapper(*args, **kwargs):
        # имя функции
        func_name = func.__name__
        # проверка это logger.Logger или обычный поток
        is_log_obj = isinstance(handle, logging.Logger)

        # сообщение о начале работы
        start_msg = f"START {func_name} args={args}, kwargs={kwargs}"
        if is_log_obj:
            handle.info(start_msg)
        else:
            handle.write(start_msg + "\n")

        try:
            result = func(*args, **kwargs)
        except Exception as e:
            # сообщение об ошибке
            err_msg = f"ERROR {func_name}: {type(e).__name__} - {e}"
            if is_log_obj:
                handle.error(err_msg)
            else:
                handle.write(err_msg + "\n")
            raise
        else:
            ok_msg = f"FINISH {func_name} -> {result!r}"
            if is_log_obj:
                handle.info(ok_msg)
            else:
                handle.write(ok_msg + "\n")
            return result

    return wrapper


2) исходный код функции get_currencies 


def get_currencies(currency_codes, url="https://www.cbr-xml-daily.ru/daily_json.js"):
    """
    функция получает курсы валют с сервера ЦБ
    возвращает словарь вида {"USD": 93.2, .}
    """

    # проверяем что передали список
    if not isinstance(currency_codes, list):
        raise TypeError("currency_codes должен быть списком")

    # пробуем сделать запрос
    try:
        r = requests.get(url)
        r.raise_for_status()
    except requests.ConnectionError:
        raise ConnectionError("не могу подключиться к API")
    except requests.Timeout:
        raise ConnectionError("API долго не отвечает")
    except requests.HTTPError:
        raise ConnectionError("ошибка HTTP при запросе")

    # пробуем прочитать JSON
    try:
        data = r.json()
    except json.JSONDecodeError:
        raise ValueError("пришел плохой JSON")

    # проверяем, что есть раздел с валютами
    if "Valute" not in data:
        raise KeyError("нет раздела Valute в ответе")

    valutes = data["Valute"]
    result = {}

    # обрабатываем все нужные валюты
    for code in currency_codes:

        # проверяем
        if code not in valutes:
            raise KeyError(f"Нет валюты {code} в списке")

        info = valutes[code]
        value = info.get("Value")

        # проверяем, что курс то есть число
        if not isinstance(value, (int, float)):
            raise TypeError(f"некорректное значение курса для {code}")

        # записываем в результат
        result[code] = float(value)

    return result


3) демонстрационный пример (решение квадратного уравнения)


@logger(handle=quad_logger)
def solve_quadratic(a, b, c):
    """
    решение квадратного уравнения без логики логирования
    """
    # проверяем типы
    for x in (a, b, c):
        if not isinstance(x, (int, float)):
            raise TypeError("коэффициенты должны быть числами")

    if a == 0 and b == 0:
        raise ValueError("a и b не могут быть оба 0")

    if a == 0:
        return [-c / b]

    d = b * b - 4 * a * c

    if d < 0:
        quad_logger.warning(f"дискриминант < 0 (D={d}) корней нет")
        return []

    if d == 0:
        x = -b / (2 * a)
        return [x]

    sqrt_d = math.sqrt(d)
    x1 = (-b + sqrt_d) / (2 * a)
    x2 = (-b - sqrt_d) / (2 * a)
    return [x1, x2]


4) фрагменты логов 

успешный вызов get_currencies
START get_currencies args=(['USD'],), kwargs={}
FINISH get_currencies -> {'USD': 92.35}

ошибка: неверный код валюты
START get_currencies args=(['ZZZ'],), kwargs={}
ERROR get_currencies: KeyError - "валюта 'ZZZ' отсутствует в данных"

ошибка: плохой URL
START get_currencies args=(['USD'],), kwargs={'url': 'https://invalid-url-address.com/api'}
ERROR get_currencies: ConnectionError - API недоступен: https://invalid-url-address.com/api

два корня
START solve_quadratic args=(1, 5, 6), kwargs={}
FINISH solve_quadratic -> [-2.0, -3.0]


5) тесты


тесты get_currencies
class TestGetCurrencies(unittest.TestCase):
    def test_currency_usd_basic(self):
        codes = ['USD']
        data = get_currencies(codes)
        self.assertIn('USD', data)
        self.assertIsInstance(data['USD'], (int, float))
        self.assertGreaterEqual(data['USD'], 0)
        self.assertLessEqual(data['USD'], MAX_R_VALUE)

тест ошибки для несуществующей валюты
def test_nonexistent_code_raises_keyerror(self):
    with self.assertRaises(KeyError):
        get_currencies(['XXX'])

тесты работы со StringIO
class TestLoggerWithStream(unittest.TestCase):
    def setUp(self):
        self.stream = io.StringIO()

        @logger(handle=self.stream)
        def wrapped_ok(x):
            return x * 2

        @logger(handle=self.stream)
        def wrapped_fail():
            return get_currencies(['USD'], url="https://invalid-url-address.com")

        self.wrapped_ok = wrapped_ok
        self.wrapped_fail = wrapped_fail

    def test_logger_success_info(self):
        result = self.wrapped_ok(5)
        logs = self.stream.getvalue()
        self.assertEqual(result, 10)
        self.assertIn("START wrapped_ok", logs)
        self.assertIn("FINISH wrapped_ok", logs)
